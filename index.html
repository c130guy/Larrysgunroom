<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Larry’s Gun Room | Beresford, SD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">

  <style>
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 20px 0;
    }
    .controls input,
    .controls select {
      padding: 8px;
      font-size: 1rem;
    }
    .item-card.sold {
      opacity: 0.5;
    }
    .sold-ribbon {
      position: absolute;
      top: 10px;
      left: -5px;
      background: #b00020;
      color: white;
      padding: 5px 12px;
      font-weight: bold;
      font-size: 0.85rem;
      transform: rotate(-5deg);
      z-index: 2;
    }
    .image-wrapper {
      position: relative;
    }
  </style>
</head>
<body>

<header class="hero">
  <h1>Larry’s Gun Room</h1>
  <p>Collecting, Dealing & Trading Since 1969</p>
</header>

<section class="controls">
  <input type="text" id="search" placeholder="Search firearms…">
  <select id="sort">
    <option value="default">Sort: Default</option>
    <option value="price-asc">Price: Low → High</option>
    <option value="price-desc">Price: High → Low</option>
  </select>
</section>

<section id="inventory" class="inventory-grid">
  <p>Loading inventory…</p>
</section>

<footer>
  <p>© Larry’s Gun Room, LLC — Beresford, South Dakota</p>
</footer>

<script>
/* ================= CONFIG ================= */

const SHEET_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQABes-BmlnfiQ4tB8tWX6Z0MNRv_rhDJjc4qomYnmuCy-xgJdt81dReyVPT7ZGAu5Mclw_sgZDZ_a/pub?gid=0&single=true&output=csv";

const API_KEY = "AIzaSyBF6oEWQAiqJcKyFfJFUJelQgOldL1ZWQg";

/* =============== DO NOT EDIT BELOW =============== */

let inventoryData = [];

fetch(SHEET_URL)
  .then(res => res.text())
  .then(csv => {
    const rows = csv.trim().split("\n").slice(1);

    inventoryData = rows.map(row => {
      const c = row.split(",").map(x => x.trim().replace(/^"|"$/g, ""));
      return {
        id: c[0],
        name: c[1],
        price: parseFloat(c[2]) || 0,
        status: (c[3] || "").toUpperCase(),
        folder: c[5] || ""
      };
    });

    renderInventory(inventoryData);
  });

function renderInventory(data) {
  const container = document.getElementById("inventory");
  container.innerHTML = "";

  data.forEach(item => {
    if (!item.id || !item.name) return;

    const card = document.createElement("a");
    card.className = "item-card";
    card.href = `/gun.html?id=${item.id}`;

    if (item.status === "SOLD") {
      card.classList.add("sold");
    }

    card.innerHTML = `
      <div class="image-wrapper">
        ${item.status === "SOLD" ? "<div class='sold-ribbon'>SOLD</div>" : ""}
        <div class="no-image">No Photo</div>
      </div>
      <h3>${item.name}</h3>
      <p class="price">$${item.price}</p>
    `;

    container.appendChild(card);

    const match = item.folder.match(/[-\w]{25,}/);
    if (!match) return;

    fetch(
      `https://www.googleapis.com/drive/v3/files` +
      `?q='${match[0]}' in parents` +
      `&spaces=drive` +
      `&supportsAllDrives=true` +
      `&includeItemsFromAllDrives=true` +
      `&orderBy=name` +
      `&pageSize=1` +
      `&fields=files(id)` +
      `&key=${API_KEY}`
    )
    .then(r => r.json())
    .then(d => {
      if (d.files && d.files.length) {
        card.querySelector(".image-wrapper").innerHTML =
          `${item.status === "SOLD" ? "<div class='sold-ribbon'>SOLD</div>" : ""}` +
          `<img src="https://drive.google.com/thumbnail?id=${d.files[0].id}&sz=w400">`;
      }
    });
  });

  if (!container.children.length) {
    container.innerHTML = "<p>No matching firearms.</p>";
  }
}

/* Search */
document.getElementById("search").addEventListener("input", e => {
  const q = e.target.value.toLowerCase();
  const filtered = inventoryData.filter(i =>
    i.name.toLowerCase().includes(q)
  );
  applySort(filtered);
});

/* Sort */
document.getElementById("sort").addEventListener("change", e => {
  applySort(getFiltered());
});

function getFiltered() {
  const q = document.getElementById("search").value.toLowerCase();
  return inventoryData.filter(i =>
    i.name.toLowerCase().includes(q)
  );
}

function applySort(data) {
  const mode = document.getElementById("sort").value;
  let sorted = [...data];

  if (mode === "price-asc") {
    sorted.sort((a,b) => a.price - b.price);
  }
  if (mode === "price-desc") {
    sorted.sort((a,b) => b.price - a.price);
  }

  renderInventory(sorted);
}
</script>

</body>
</html>






