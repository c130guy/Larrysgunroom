<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Firearm Details | Larry’s Gun Room</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<a href="/" style="display:block; margin:20px;">← Back to Inventory</a>

<main id="gun">
  <p>Loading firearm details…</p>
</main>

<script>
/* ========= CONFIG (EDIT THESE TWO LINES ONLY) ========= */

var SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQABes-BmlnfiQ4tB8tWX6Z0MNRv_rhDJjc4qomYnmuCy-xgJdt81dReyVPT7ZGAu5Mclw_sgZDZ_a/pub?gid=0&single=true&output=csv";
var API_KEY   = "AIzaSyBF6oEWQAiqJcKyFfJFUJelQgOldL1ZWQg";

/* ========= DO NOT EDIT BELOW THIS LINE ========= */

var params = new URLSearchParams(window.location.search);
var id = params.get("id");

if (!id) {
  document.getElementById("gun").innerHTML = "<p>Invalid firearm link.</p>";
} else {

  fetch(SHEET_URL)
    .then(function(res) { return res.text(); })
    .then(function(csv) {

      var rows = csv.trim().split("\n").slice(1).map(function(r) {
        return r.split(",");
      });

      var gun = rows.find(function(r) {
        return r[0].trim() === id.trim();
      });

      if (!gun) {
        document.getElementById("gun").innerHTML = "<p>Firearm not found.</p>";
        return;
      }

      var name    = gun[1];
      var price   = gun[2];
      var status  = gun[3];
      var details = gun[4];
      var folderURL = gun[5];

      if (!folderURL) {
        document.getElementById("gun").innerHTML =
          "<h1>" + name + "</h1>" +
          "<p class='price'>$" + price + "</p>" +
          "<p>" + details + "</p>" +
          "<p><em>No photos available.</em></p>";
        return;
      }

      var match = folderURL.match(/[-\w]{25,}/);
      if (!match) {
        document.getElementById("gun").innerHTML = "<p>Invalid photo folder link.</p>";
        return;
      }

      var folderId = match[0];

      fetch(
        "https://www.googleapis.com/drive/v3/files?q='" +
        folderId +
        "'+in+parents&fields=files(id,name)&key=" +
        API_KEY
      )
      .then(function(res) { return res.json(); })
      .then(function(data) {

        var imagesHTML = "";
        if (data.files && data.files.length) {
          data.files.forEach(function(f) {
            imagesHTML +=
              "<img src='https://drive.google.com/uc?id=" +
              f.id +
              "' style='max-width:300px;margin:10px;'>";
          });
        } else {
          imagesHTML = "<em>No photos found in folder.</em>";
        }

        var badgeHTML = "";
        if (status && status !== "AVAILABLE") {
          badgeHTML = "<div class='badge'>" + status + "</div>";
        }

        document.getElementById("gun").innerHTML =
          "<h1>" + name + "</h1>" +
          badgeHTML +
          "<p class='price'>$" + price + "</p>" +
          "<p>" + details + "</p>" +
          "<div>" + imagesHTML + "</div>";
      })
      .catch(function() {
        document.getElementById("gun").innerHTML = "<p>Error loading photos.</p>";
      });
    })
    .catch(function() {
      document.getElementById("gun").innerHTML = "<p>Error loading firearm.</p>";
    });
}
</script>

</body>
</html>
